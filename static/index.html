import os
import subprocess
import tempfile
from flask import Flask, request, jsonify, send_from_directory

app = Flask(__name__, static_folder='static', static_url_path='/static')
print("STATIC FOLDER:", app.static_folder)
print("CURRENT WORKING DIR:", os.getcwd())

# ---- Serve UI ----
@app.route("/")
def home():
    return send_from_directory(app.static_folder, "index.html")

@app.route("/static/index.html")
def static_index():
    return send_from_directory(app.static_folder, "index.html")


# ---- Run Code Endpoint ----
@app.route("/run", methods=["POST"])
def run_code():
    data = request.json
    code = data.get("code", "")

    if not code:
        return jsonify({"error": "No code provided"}), 400

    with tempfile.NamedTemporaryFile(delete=False, suffix=".py") as tmp:
        tmp.write(code.encode())
        tmp_path = tmp.name

    try:
        cmd = [
            "docker", "run",
            "--rm",
            "-v", f"{tmp_path}:/code.py",
            "python:3.11-slim",
            "python", "/code.py"
        ]

        result = subprocess.run(cmd, capture_output=True, text=True)
        output = result.stdout or result.stderr
        return jsonify({"output": output})

    finally:
        os.remove(tmp_path)


if __name__ == "__main__":
    app.run(debug=True)
